name: PerfumeOnMe FastAPI CI/CD

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # ì˜ì¡´ì„± ìºì‹œ ìµœì í™”
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Docker Image Build
        run: docker build -t chanee29/perfume-recommender .

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Hub Push
        run: docker push chanee29/perfume-recommender

      - name: Get GitHub IP
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_KEY_PASSWORD }}
          aws-region: ap-northeast-1

      - name: Add GitHub IP to AWS
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

      - name: AWS EC2 Connection and Deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          timeout: 500s
          script: |
            echo "ğŸš€ FastAPI ë°°í¬ ì‹œì‘..."
            
            # ê¸°ì¡´ FastAPI ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            sudo docker stop perfume-recommender-container || true
            sudo docker rm perfume-recommender-container || true
            sudo docker rmi chanee29/perfume-recommender || true
            
            # ìƒˆ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            sudo docker pull chanee29/perfume-recommender
            
            echo "ğŸš€ FastAPI ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            
            # FastAPI ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (Spring Bootì™€ ë™ì¼í•œ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‹¤í–‰)
            sudo docker run -d \
              --name perfume-recommender-container \
              --network bridge \
              -p 8000:8000 \
              -e OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
              --restart unless-stopped \
              chanee29/perfume-recommender
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 15
            
            if [ "$(sudo docker ps -q -f name=perfume-recommender-container)" ]; then
              echo "âœ… FastAPI ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
              
              # í—¬ìŠ¤ì²´í¬
              echo "ğŸ©º API í—¬ìŠ¤ì²´í¬ ì¤‘..."
              sleep 10
              
              # Docker ë„¤íŠ¸ì›Œí¬ì—ì„œ í—¬ìŠ¤ì²´í¬
              if sudo docker exec perfume-recommender-container curl -f http://localhost:8000/docs > /dev/null 2>&1; then
                echo "âœ… FastAPIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•˜ê³  ìˆìŠµë‹ˆë‹¤!"
                echo "ğŸ“‹ API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}:8000/docs"
              else
                echo "âš ï¸  API ì‘ë‹µ í™•ì¸ ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
                echo "ğŸ“‹ ë¡œê·¸ í™•ì¸: sudo docker logs perfume-recommender-container"
              fi
              
              # ì»¨í…Œì´ë„ˆ ì •ë³´ ì¶œë ¥
              echo "ğŸ“Š ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
              sudo docker ps --filter name=perfume-recommender-container --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              
            else
              echo "âŒ FastAPI ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨!"
              echo "ğŸ“‹ ë¡œê·¸ í™•ì¸: sudo docker logs perfume-recommender-container"
              exit 1
            fi
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬..."
            sudo docker image prune -f
            
            echo "âœ… FastAPI ë°°í¬ ì™„ë£Œ!"

      - name: Remove GitHub IP from Security Group
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32