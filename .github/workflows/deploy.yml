name: PerfumeOnMe FastAPI CI/CD (CPU ìµœì í™”)

on:
  push:
    branches: [ "main", "develop" ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›

env:
  DOCKER_IMAGE: chanee29/perfume-recommender
  DOCKER_TAG: latest

jobs:
  # =============================================================================
  # ë¹Œë“œ & í‘¸ì‹œ Job (ìµœì í™”ëœ ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ)
  # =============================================================================
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker Buildx ì„¤ì • (ê³ ê¸‰ ë¹Œë“œ ê¸°ëŠ¥)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker ë ˆì´ì–´ ìºì‹± ì„¤ì •
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # ë©€í‹°ìŠ¤í…Œì´ì§€ Docker ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          platforms: linux/amd64  # CPU ì „ìš©
          
      # ìºì‹œ ì—…ë°ì´íŠ¸
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # =============================================================================
  # ë°°í¬ Job (EC2 ë””ìŠ¤í¬ ê³µê°„ ê´€ë¦¬ í¬í•¨)
  # =============================================================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Get GitHub IP
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ACCESS_KEY_PASSWORD }}
          aws-region: ap-northeast-1

      - name: Add GitHub IP to AWS Security Group
        run: |
          aws ec2 authorize-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32

      - name: Deploy to EC2 (CPU ìµœì í™”)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          timeout: 600s
          script: |
            echo "ğŸš€ PerfumeOnMe FastAPI ë°°í¬ ì‹œì‘ (CPU ìµœì í™” ë²„ì „)..."
            echo "=================================================="
            
            # ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸
            echo "ğŸ’» ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸:"
            df -h
            free -h
            
            # ğŸ§¹ Docker ì‹œìŠ¤í…œ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
            echo "ğŸ§¹ ê¸°ì¡´ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
            sudo docker system prune -a -f || true
            sudo docker volume prune -f || true
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ”„ ê¸°ì¡´ FastAPI ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°..."
            sudo docker stop perfume-recommender-container || true
            sudo docker rm perfume-recommender-container || true
            
            # ìµœì‹  ì´ë¯¸ì§€ Pull (CPU ìµœì í™” ë²„ì „)
            echo "ğŸ“¥ ìµœì‹  Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            sudo docker pull ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            
            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (CPU ìµœì í™” ì„¤ì •)
            echo "ğŸš€ FastAPI ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            sudo docker run -d \
              --name perfume-recommender-container \
              --network perfume-network \
              --restart unless-stopped \
              -p 8000:8000 \
              -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_S3_ACCESS_KEY_ID }}" \
              -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}" \
              -e AWS_REGION=ap-northeast-1 \
              -e S3_BUCKET="${{ secrets.AWS_S3_BUCKET_NAME }}" \
              -e S3_KEY="${{ secrets.AWS_S3_BUCKET_KEY }}" \
              --memory=1g \
              --cpus=1.0 \
              ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (CPU ë²„ì „ì€ ì´ˆê¸°í™” ì‹œê°„ì´ ë” ì§§ìŒ)
            echo "â³ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (CPU ìµœì í™”ë¡œ ë¹ ë¥¸ ì‹œì‘)"
            sleep 30
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            if [ "$(sudo docker ps -q -f name=perfume-recommender-container)" ]; then
              echo "âœ… FastAPI ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
              
              # ì»¨í…Œì´ë„ˆ ì •ë³´ ì¶œë ¥
              echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
              sudo docker ps --filter name=perfume-recommender-container --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Size}}"
              
              # ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
              echo "ğŸ“ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
              sudo docker stats perfume-recommender-container --no-stream
              
              # API í—¬ìŠ¤ì²´í¬ (CPU ë²„ì „ì— ë§ê²Œ ì¡°ì •)
              echo "ğŸ©º API í—¬ìŠ¤ì²´í¬ ì¤‘... (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)"
              for i in {1..12}; do
                if sudo docker exec perfume-recommender-container curl -f http://localhost:8000/docs > /dev/null 2>&1; then
                  echo "âœ… FastAPIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•˜ê³  ìˆìŠµë‹ˆë‹¤!"
                  echo "ğŸ“‹ API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}:8000/docs"
                  echo "ğŸ”— ì¶”ì²œ API: http://${{ secrets.EC2_HOST }}:8000/recommend/full"
                  break
                else
                  echo "â³ API ì‘ë‹µ ëŒ€ê¸° ì¤‘... ($i/12)"
                  sleep 5
                fi
              done
              
              # ìµœì¢… ë¡œê·¸ í™•ì¸
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ìµœê·¼ ë¡œê·¸:"
              sudo docker logs --tail 10 perfume-recommender-container
              
            else
              echo "âŒ FastAPI ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨!"
              echo "ğŸ“‹ ì‹¤íŒ¨ ë¡œê·¸:"
              sudo docker logs perfume-recommender-container || true
              exit 1
            fi
            
            # ìµœì¢… ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
            echo "ğŸ’» ë°°í¬ í›„ ì‹œìŠ¤í…œ ìƒíƒœ:"
            df -h
            sudo docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
            
            echo "âœ… PerfumeOnMe FastAPI ë°°í¬ ì™„ë£Œ! (CPU ìµœì í™” ë²„ì „)"

      - name: Remove GitHub IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress --group-id ${{ secrets.AWS_SG_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32